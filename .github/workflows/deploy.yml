name: Deploy Flight Chatbot

on:
  push:
    branches:
      - main  

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Copy files via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.KEY }}
        script: |
          echo "✅ Switching to project dir"
          cd ~/Flight_chatbot

          echo "✅ Pulling latest code"
          git pull origin main

          echo "✅ Creating .env file"
          cat <<EOF > .env
          AMADEUS_API_KEY=${{ secrets.AMADEUS_API_KEY }}
          AMADEUS_API_SECRET=${{ secrets.AMADEUS_API_SECRET }}
          BASE_URL=${{ secrets.BASE_URL }}
          GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF

          echo "✅ Installing dependencies"
          source venv/bin/activate
          pip install -r requirements.txt

          echo "✅ Restarting PM2 process"
          pm2 stop flight-chatbot || true
          pm2 delete flight-chatbot || true
          pm2 start "venv/bin/uvicorn app:app --host 0.0.0.0 --port 8001" --name flight-chatbot
          pm2 save

          echo "✅ PM2 status:"
          pm2 status
